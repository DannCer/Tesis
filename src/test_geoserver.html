<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Conexi√≥n GeoServer</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .config-form {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .result.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .result.error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .result.warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .test-list {
            list-style: none;
            padding: 0;
        }
        .test-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #ccc;
        }
        .test-item.success {
            border-color: #28a745;
        }
        .test-item.error {
            border-color: #dc3545;
        }
        .test-item.running {
            border-color: #ffc107;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border: 1px solid #dee2e6;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test de Conexi√≥n GeoServer - Capas R√°ster</h1>
        
        <div class="config-form">
            <div class="form-group">
                <label for="geoserverUrl">URL de GeoServer:</label>
                <input type="text" id="geoserverUrl" value="http://localhost:8080" placeholder="http://localhost:8080">
            </div>
            
            <div class="form-group">
                <label for="workspace">Workspace:</label>
                <input type="text" id="workspace" value="Tesis" placeholder="Tesis">
            </div>
            
            <div class="form-group">
                <label for="layerName">Nombre de la capa:</label>
                <input type="text" id="layerName" value="usv_mosaico" placeholder="usv_mosaico">
            </div>
            
            <button id="testBtn" onclick="runTests()">‚ñ∂Ô∏è Ejecutar Pruebas</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        let resultsDiv = document.getElementById('results');

        function showResult(message, type = 'success') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            resultsDiv.appendChild(div);
        }

        function addTestItem(message, status = 'running') {
            const item = document.createElement('li');
            item.className = `test-item ${status}`;
            
            if (status === 'running') {
                item.innerHTML = `<div class="spinner"></div>${message}`;
            } else {
                const icon = status === 'success' ? '‚úÖ' : '‚ùå';
                item.innerHTML = `${icon} ${message}`;
            }
            
            return item;
        }

        async function runTests() {
            resultsDiv.innerHTML = '';
            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;

            const geoserverUrl = document.getElementById('geoserverUrl').value.trim();
            const workspace = document.getElementById('workspace').value.trim();
            const layerName = document.getElementById('layerName').value.trim();

            const testList = document.createElement('ul');
            testList.className = 'test-list';
            resultsDiv.appendChild(testList);

            // Test 1: GetCapabilities
            const test1 = addTestItem('Probando GetCapabilities...', 'running');
            testList.appendChild(test1);

            try {
                const capUrl = `${geoserverUrl}/geoserver/${workspace}/wms?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetCapabilities`;
                const response = await fetch(capUrl);
                
                if (response.ok) {
                    const xml = await response.text();
                    test1.className = 'test-item success';
                    test1.innerHTML = `‚úÖ GetCapabilities exitoso - GeoServer accesible`;
                    
                    // Verificar si la capa existe
                    if (xml.includes(layerName)) {
                        showResult(`‚úÖ La capa "${layerName}" existe en GeoServer`, 'success');
                    } else {
                        showResult(`‚ö†Ô∏è La capa "${layerName}" NO se encontr√≥ en GetCapabilities`, 'warning');
                    }
                } else {
                    test1.className = 'test-item error';
                    test1.innerHTML = `‚ùå Error ${response.status}: ${response.statusText}`;
                }
            } catch (error) {
                test1.className = 'test-item error';
                test1.innerHTML = `‚ùå Error de conexi√≥n: ${error.message}`;
                showResult(`
                    <strong>Posibles causas:</strong><br>
                    ‚Ä¢ GeoServer no est√° corriendo<br>
                    ‚Ä¢ URL incorrecta<br>
                    ‚Ä¢ Problema de CORS<br>
                    ‚Ä¢ Firewall bloqueando la conexi√≥n
                `, 'error');
            }

            // Test 2: GetMap (imagen de prueba)
            const test2 = addTestItem('Probando GetMap...', 'running');
            testList.appendChild(test2);

            try {
                const mapUrl = `${geoserverUrl}/geoserver/${workspace}/wms?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&LAYERS=${workspace}:${layerName}&FORMAT=image/png&TRANSPARENT=true&HEIGHT=256&WIDTH=256&SRS=EPSG:4326&BBOX=-102,23,-101,24`;
                
                const img = new Image();
                img.onload = () => {
                    test2.className = 'test-item success';
                    test2.innerHTML = `‚úÖ GetMap exitoso - La capa se puede renderizar`;
                    
                    showResult(`
                        <strong>‚úÖ ¬°√âxito! La capa se puede visualizar</strong><br><br>
                        <strong>URL WMS construida:</strong><br>
                        <pre>${geoserverUrl}/geoserver/${workspace}/wms</pre>
                        <strong>Prueba esta imagen:</strong><br>
                        <img src="${mapUrl}" style="max-width: 100%; border: 2px solid #28a745; border-radius: 5px; margin-top: 10px;">
                    `, 'success');
                };
                
                img.onerror = () => {
                    test2.className = 'test-item error';
                    test2.innerHTML = `‚ùå Error al cargar imagen - La capa existe pero no se puede renderizar`;
                    showResult(`
                        <strong>‚ö†Ô∏è La capa existe pero hay un problema al renderizarla</strong><br><br>
                        <strong>Verifica:</strong><br>
                        ‚Ä¢ Que la capa tenga datos<br>
                        ‚Ä¢ Que el estilo est√© configurado<br>
                        ‚Ä¢ Que el BBOX sea correcto<br>
                        ‚Ä¢ Revisa los logs de GeoServer
                    `, 'warning');
                };
                
                img.src = mapUrl;
                
            } catch (error) {
                test2.className = 'test-item error';
                test2.innerHTML = `‚ùå Error en GetMap: ${error.message}`;
            }

            // Test 3: GetMap con TIME
            const test3 = addTestItem('Probando GetMap con par√°metro TIME...', 'running');
            testList.appendChild(test3);

            try {
                const mapUrlWithTime = `${geoserverUrl}/geoserver/${workspace}/wms?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&LAYERS=${workspace}:${layerName}&FORMAT=image/png&TRANSPARENT=true&HEIGHT=256&WIDTH=256&SRS=EPSG:4326&BBOX=-102,23,-101,24&TIME=2018-01-01`;
                
                const imgTime = new Image();
                imgTime.onload = () => {
                    test3.className = 'test-item success';
                    test3.innerHTML = `‚úÖ GetMap con TIME exitoso`;
                    
                    showResult(`
                        <strong>‚úÖ La dimensi√≥n temporal funciona correctamente</strong><br><br>
                        <strong>Imagen con TIME=2018-01-01:</strong><br>
                        <img src="${mapUrlWithTime}" style="max-width: 100%; border: 2px solid #28a745; border-radius: 5px; margin-top: 10px;">
                    `, 'success');
                };
                
                imgTime.onerror = () => {
                    test3.className = 'test-item error';
                    test3.innerHTML = `‚ùå Error con par√°metro TIME`;
                    showResult(`
                        <strong>‚ö†Ô∏è Problema con la dimensi√≥n temporal</strong><br><br>
                        <strong>Verifica en GeoServer:</strong><br>
                        ‚Ä¢ Que la capa tenga la dimensi√≥n TIME habilitada<br>
                        ‚Ä¢ Que el formato de fecha sea correcto (YYYY-MM-DD)<br>
                        ‚Ä¢ Que existan datos para esa fecha
                    `, 'warning');
                };
                
                imgTime.src = mapUrlWithTime;
                
            } catch (error) {
                test3.className = 'test-item error';
                test3.innerHTML = `‚ùå Error en GetMap con TIME: ${error.message}`;
            }

            testBtn.disabled = false;
        }

        // Ejecutar autom√°ticamente al cargar
        window.addEventListener('load', () => {
            setTimeout(runTests, 500);
        });
    </script>
</body>
</html>
